{% extends "bootstrap_5_layout.html" %}
{% set active_page = "organization?ein" %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4">{{org_info.name}} Financial Data</h2>

    <!-- Revenue vs Expenses Graph -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title">Revenue vs Expenses Over Time</h5>
        </div>
        <div class="card-body">
            <div id="revenue-expenses-chart" style="height: 500px;"></div>
        </div>
    </div>

    <!-- Total Assets Graph -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title">Total Assets Over Time</h5>
        </div>
        <div class="card-body">
            <div id="assets-chart" style="height: 500px;"></div>
        </div>
    </div>

    <!-- Financial Data Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title">Financial Summary</h5>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Year</th>
                        <th scope="col">Total Revenue</th>
                        <th scope="col">Total Expenses</th>
                        <th scope="col">Total Assets</th>
                        <th scope="col">Statement</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in organization_financials|sort(attribute='Year', reverse=True) %}
                    <tr>
                        <th scope="row">{{ loop.index }}</th>
                        <td>{{ data.Year }}</td>
                        <td>${{ '{:,.0f}'.format(data['Total Revenue']) }}</td>
                        <td>${{ '{:,.0f}'.format(data['Total Expenses']) }}</td>
                        <td>${{ '{:,.0f}'.format(data['Total Assets']) }}</td>
                        <td>
                            {% if data.URL %}
                            <a href="{{ data.URL }}" target="_blank" class="btn btn-sm btn-primary">
                                View PDF
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Include Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script type="text/javascript">
    console.log("FINANCIAL DASHBOARD...");

    // Parse the financial data
    var financialData = JSON.parse('{{organization_financials | tojson | safe}}');
    console.log("Financial Data:", financialData);

    // Prepare data for plots
    var years = financialData.map(obj => obj.Year);
    var revenues = financialData.map(obj => obj['Total Revenue']);
    var expenses = financialData.map(obj => obj['Total Expenses']);
    var assets = financialData.map(obj => obj['Total Assets']);

    // Create Revenue vs Expenses plot
    var revenueSeries = {
        x: years,
        y: revenues,
        name: 'Total Revenue',
        mode: 'lines+markers',
        line: {color: '#0d6efd'}
    };

    var expensesSeries = {
        x: years,
        y: expenses,
        name: 'Total Expenses',
        mode: 'lines+markers',
        line: {color: '#dc3545'}
    };

    var layout1 = {
        title: 'Revenue vs Expenses Over Time',
        height: 500,
        yaxis: {
            tickformat: '$,',
            title: 'Amount ($)'
        },
        xaxis: {
            title: 'Year'
        },
        showlegend: true,
        legend: {
            x: 0,
            y: 1.2
        }
    };

    Plotly.newPlot('revenue-expenses-chart', [revenueSeries, expensesSeries], layout1, {responsive: true});

    // Create Assets plot
    var assetsSeries = {
        x: years,
        y: assets,
        name: 'Total Assets',
        mode: 'lines+markers',
        line: {color: '#198754'}
    };

    var layout2 = {
        title: 'Total Assets Over Time',
        height: 500,
        yaxis: {
            tickformat: '$,',
            title: 'Amount ($)'
        },
        xaxis: {
            title: 'Year'
        }
    };

    Plotly.newPlot('assets-chart', [assetsSeries], layout2, {responsive: true});
</script>
{% endblock %}